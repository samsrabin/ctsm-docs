

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>1.3.5. Creating Surface Datasets &mdash; ctsm CTSM master documentation</title>
  

  
  
  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  

  
    <link rel="stylesheet" href="../../_static/css/custom.css" type="text/css" />
  

  
        <link rel="index" title="Index"
              href="../../genindex.html"/>
        <link rel="search" title="Search" href="../../search.html"/>
    <link rel="top" title="ctsm CTSM master documentation" href="../../index.html"/>
        <link rel="up" title="1.3. Using CLM tools" href="index.html"/>
        <link rel="next" title="1.3.6. Creating CLM domain files" href="creating-domain-files.html"/>
        <link rel="prev" title="1.3.4. Creating input for surface dataset generation" href="creating-input-for-surface-dataset-generation.html"/> 

  
  <script src="../../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../../index.html" class="icon icon-home"> ctsm
          

          
          </a>

          
            
            
              <div class="version">
                
                  <div class="version-dropdown">
                    <select class="version-list" id="version-list">
                      <option value=''>CTSM1</option>
                      
                        
                      
                        
                          <option value="">[placeholder]</option>
                        
                      
                    </select>
                  </div>
                
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="../index.html">1. CTSM1 User’s Guide</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../overview/index.html">1.1. Overview</a></li>
<li class="toctree-l2"><a class="reference internal" href="../setting-up-and-running-a-case/index.html">1.2. Setting Up and Running a Case</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="index.html">1.3. Using CLM tools</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="what-are-the-clm-tools.html">1.3.1. What are the CLM tools</a></li>
<li class="toctree-l3"><a class="reference internal" href="building-the-clm-tools.html">1.3.2. Building the CLM tools</a></li>
<li class="toctree-l3"><a class="reference internal" href="building-the-clm-tools.html#building-the-clm-tools-that-use-the-cime-configure-build-system">1.3.3. Building the CLM tools that use the CIME configure/build system</a></li>
<li class="toctree-l3"><a class="reference internal" href="creating-input-for-surface-dataset-generation.html">1.3.4. Creating input for surface dataset generation</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">1.3.5. Creating Surface Datasets</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#creating-a-complete-set-of-files-for-input-to-clm">1.3.5.1. Creating a Complete Set of Files for Input to CLM</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="creating-domain-files.html">1.3.6. Creating CLM domain files</a></li>
<li class="toctree-l3"><a class="reference internal" href="observational-sites-datasets.html">1.3.7. Observational Sites Datasets</a></li>
<li class="toctree-l3"><a class="reference internal" href="cprnc.html">1.3.8. Comparing History Files</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../adding-new-resolutions/index.html">1.4. Adding New Resolutions</a></li>
<li class="toctree-l2"><a class="reference internal" href="../running-special-cases/index.html">1.5. Running Special Cases</a></li>
<li class="toctree-l2"><a class="reference internal" href="../running-single-points/index.html">1.6. Running Single Point Regional Cases</a></li>
<li class="toctree-l2"><a class="reference internal" href="../trouble-shooting/index.html">1.7. Troubleshooting</a></li>
<li class="toctree-l2"><a class="reference internal" href="../testing/index.html">1.8. Testing</a></li>
<li class="toctree-l2"><a class="reference internal" href="../using-mesh-maker/index.html">1.9. Using mesh_maker</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../tech_note/index.html">2. CLM Technical Note</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../lilac/index.html">3. CTSM-LILAC User’s Guide</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">ctsm</a>
        
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../index.html"><span class="section-number">1. </span>CTSM1 User’s Guide</a> &raquo;</li>
        
          <li><a href="index.html"><span class="section-number">1.3. </span>Using CLM tools</a> &raquo;</li>
        
      <li><span class="section-number">1.3.5. </span>Creating Surface Datasets</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../../_sources/users_guide/using-clm-tools/creating-surface-datasets.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="creating-surface-datasets">
<span id="id1"></span><h1><span class="section-number">1.3.5. </span>Creating Surface Datasets<a class="headerlink" href="#creating-surface-datasets" title="Permalink to this headline">¶</a></h1>
<p>When just creating a replacement file for an existing one, the relevant tool should be used directly to create the file. When you are creating a set of files for a new resolution there are some dependencies between the tools that you need to keep in mind when creating them. The main dependency is that you MUST create a SCRIP grid file first as the SCRIP grid dataset is then input into the other tools. Also look at Table <a class="reference internal" href="../adding-new-resolutions/Adding-or-Changing-Default-Filenames.html#reqd-files-table"><span class="std std-numref">1.4.3.1.1</span></a> which gives information on the files required and when. <a class="reference internal" href="#figure-data-flow"><span class="std std-numref">Figure 1.3.2</span></a> shows an overview of the general data-flow for creation of the fsurdat datasets.</p>
<div class="figure align-default" id="id2">
<span id="figure-data-flow"></span><img alt="../../_images/mkmapdata_mksurfdata.jpeg" src="../../_images/mkmapdata_mksurfdata.jpeg" />
<p class="caption"><span class="caption-number">Figure 1.3.2 </span><span class="caption-text">Data Flow for Creation of Surface Datasets from Raw SCRIP Grid Files</span><a class="headerlink" href="#id2" title="Permalink to this image">¶</a></p>
</div>
<p>Starting from a SCRIP grid file that describes the grid you will run the model on, you first run <code class="docutils literal notranslate"><span class="pre">`mkmapdata.sh</span></code> to create a list of mapping files. See <a class="reference internal" href="creating-input-for-surface-dataset-generation.html#figure-mkmapdata-sh"><span class="std std-numref">Figure 1.3.1</span></a> for a more detailed view of how <code class="docutils literal notranslate"><span class="pre">mkmapdata.sh</span></code> works. The mapping files tell <code class="docutils literal notranslate"><span class="pre">mksurfdata_esmf</span></code> how to map between the output grid and the raw datasets that it uses as input. The output of <code class="docutils literal notranslate"><span class="pre">mksurfdata_esmf</span></code> is a surface dataset that you then use for running the model. See <a class="reference internal" href="../../tech_note/Transient_Landcover/CLM50_Tech_Note_Transient_Landcover.html#figure-workflow-of-clm5-land-use-data-tool-and-mksurfdata-esmf-tool"><span class="std std-numref">Figure 2.27.3</span></a> for a more detailed view of how <code class="docutils literal notranslate"><span class="pre">mksurfdata_esmf</span></code> works.</p>
<p><a class="reference internal" href="#figure-data-flow-legend"><span class="std std-numref">Figure 1.3.3</span></a> is the legend for this figure (<a class="reference internal" href="#figure-data-flow"><span class="std std-numref">Figure 1.3.2</span></a>) and other figures in this chapter (<a class="reference internal" href="creating-domain-files.html#figure-global-domain"><span class="std std-numref">Figure 1.3.4</span></a> and <a class="reference internal" href="creating-domain-files.html#figure-mknoocnmap-pl"><span class="std std-numref">Figure 1.3.5</span></a>).</p>
<div class="figure align-default" id="id3">
<span id="figure-data-flow-legend"></span><img alt="../../_images/LegendCLMToolDataFlow.jpeg" src="../../_images/LegendCLMToolDataFlow.jpeg" />
<p class="caption"><span class="caption-number">Figure 1.3.3 </span><span class="caption-text">Legend for Data Flow Figures</span><a class="headerlink" href="#id3" title="Permalink to this image">¶</a></p>
</div>
<p>Green arrows define the input to a program, while red arrows define the output. Cylinders define files that are either created by a program or used as input for a program. Boxes are programs.</p>
<p>You start with a description of a SCRIP grid file for your output grid file and then create mapping files from the raw datasets to it. Once, the mapping files are created <code class="docutils literal notranslate"><span class="pre">mksurfdata_esmf</span></code> is run to create the surface dataset to run the model.</p>
<div class="section" id="creating-a-complete-set-of-files-for-input-to-clm">
<h2><span class="section-number">1.3.5.1. </span>Creating a Complete Set of Files for Input to CLM<a class="headerlink" href="#creating-a-complete-set-of-files-for-input-to-clm" title="Permalink to this headline">¶</a></h2>
<ol class="arabic">
<li><p>Create SCRIP grid datasets (if NOT already done)</p>
<p>First you need to create a descriptor file for your grid, that includes the locations of cell centers and cell corners. There is also a “mask” field, but in this case the mask is set to one everywhere (i.e. all of the masks for the output model grid are “nomask”). An example SCRIP grid file is: <code class="docutils literal notranslate"><span class="pre">$CSMDATA/lnd/clm2/mappingdata/grids/SCRIPgrid_10x15_nomask_c110308.nc</span></code>. The <code class="docutils literal notranslate"><span class="pre">mkmapgrids</span></code> and <code class="docutils literal notranslate"><span class="pre">mkscripgrid.ncl</span></code> NCL script in the <code class="docutils literal notranslate"><span class="pre">$CTSMROOT/tools/mkmapgrids</span></code> directory can help you with this. SCRIP grid files for all the standard CLM grids are already created for you. See the Section called Creating an output SCRIP grid file at a resolution to run the model on for more information on this.</p>
</li>
<li><p>Create domain dataset (if NOT already done)</p>
<p>Next use <code class="docutils literal notranslate"><span class="pre">gen_domain</span></code> to create a domain file for use by DATM and CLM. This is required, unless a domain file was already created. See the Section called Creating a domain file for CLM and DATM for more information on this.</p>
</li>
<li><p>Create mapping files for <code class="docutils literal notranslate"><span class="pre">mksurfdata_esmf</span></code> (if NOT already done)</p>
<p>Create mapping files for <code class="docutils literal notranslate"><span class="pre">mksurfdata_esmf</span></code> with <code class="docutils literal notranslate"><span class="pre">mkmapdata.sh</span></code> in <code class="docutils literal notranslate"><span class="pre">$CTSMROOT/tools/mkmapdata</span></code>. See the Section called Creating mapping files that <code class="docutils literal notranslate"><span class="pre">mksurfdata_esmf</span></code> will use for more information on this.</p>
</li>
<li><p>Create surface datasets</p>
<p>Next use <code class="docutils literal notranslate"><span class="pre">mksurfdata_esmf</span></code> to create a surface dataset, using the mapping datasets created on the previous step as input. There is a version for either clm4_0 or CTSM1 for this program. See the Section called Using <code class="docutils literal notranslate"><span class="pre">mksurfdata_esmf</span></code> to create surface datasets from grid datasets for more information on this.</p>
</li>
<li><p>Enter the new datasets into the <code class="docutils literal notranslate"><span class="pre">build-namelist</span></code> XML database
The last optional thing to do is to enter the new datasets into the <code class="docutils literal notranslate"><span class="pre">build-namelist</span></code> XML database. See Chapter 3 for more information on doing this. This is optional because the user may enter these files into their namelists manually. The advantage of entering them into the database is so that they automatically come up when you create new cases.</p></li>
</ol>
<p>The <code class="docutils literal notranslate"><span class="pre">$CTSMROOT/tools/README</span></code> goes through the complete process for creating input files needed to run CLM. We repeat that file here:</p>
<pre class="literal-block">$CTSMROOT/tools/README                                  Jun/08/2018

CTSM tools for analysis of CTSM history files -- or for creation or
modification of CTSM input files.
        
I.  General directory structure:

    $CTSMROOT/tools
        mksurfdata_esmf -- Create surface datasets.

        crop_calendars --- Regrid and process GGCMI sowing and harvest date files for use in CTSM.

        mkmapgrids ------- Create regular lat/lon SCRIP grid files
        mkprocdata_map --- Convert output unstructured grids into a 2D format that
                           can be plotted easily

        site_and_regional  Scripts for handling input datasets for site and regional cases.
                           These scripts both help with creation of datasets using the 
                           standard process as well as subsetting existing datasets and overwriting
                           some aspects for a specific case.

        modify_input_files Scripts to modify CTSM input files. Specifically modifying the surface
                           datasets and mesh files.

        contrib ---------- Miscellaneous tools for pre or post processing of CTSM.
                           Typically these are contributed by anyone who has something
                           they think might be helpful to the community. They may not
                           be as well tested or supported as other tools.

    cime-tools ($CIMEROOT/tools/) (CIMEROOT is ../cime for a CTSM checkout and ../../../cime for a CESM checkout)
        $CIMEROOT/mapping/gen_domain_files
            gen_domain ------- Create data model domain datasets from SCRIP mapping datasets.

II. Notes on building/running for each of the above tools:

    mkprocdata_map has the following files to facilitate building the FORTRAN code:

        README ------- Specific help for using the specific tool and help on specific 
                       files in that directory.
        src/Filepath ----- List of directories needed to build the tool 
                           (some files in ../src directories are required).
        src/Makefile ----- GNU Makefile to build the tool 
                           (these are identical between tools.
        src/Macros.custom  Customization of make macros for the particular tool in question
        src/Srcfiles ----- List of source files that are needed.
        src/Mkdepends ---- Dependency generator program

    To build:

        cd &lt;directory&gt;
        setenv INC_NETCDF &lt;path-to-NetCDF-include-files&gt;
        setenv LIB_NETCDF &lt;path-to-NetCDF-library-files&gt;
        gmake

    The process will create a file called &quot;Depends&quot; which has the dependencies
    for the build of each file on other files.

      By default some codes may be compiled non-optimized 
      so that you can use the debugger, and with bounds-checking, and float trapping on. 
      To speed up do the following...

   gmake OPT=TRUE

      Also some of the tools allow for OpenMP shared memory parallelism 
      (such as mksurfdata) with

   gmake SMP=TRUE

    To run a program with a namelist:

        ./program &lt; namelist

    To run a program built with SMP=TRUE:

        setenv OMP_NUM_THREADS=&lt;number_of_threads_to_use&gt;

        run normally as above

    mksurfdata_esmf has a cime configure and CMake based build using the following files:

        gen_mksurfdata_build ---- Build mksurfdata_esmf
        src/CMakeLists.txt ------ Tells CMake how to build the source code
        Makefile ---------------- GNU makefile to link the program together
        cmake ------------------- CMake macros for finding libraries

    mkmapgrids, and site_and_regional only contain scripts so don't have the above build files.

    Some tools have copies of files from other directories -- see the README.filecopies
    file for more information on this.

    Tools may also have files with the directory name followed by namelist to provide sample namelists.

        &lt;directory&gt;.namelist ------ Namelist to create a global file.

    These files are also used by the test scripts to test the tools (see the
    README.testing) file.

    NOTE: Be sure to change the path of the datasets references by these namelists to 
    point to where you have exported your CESM inputdata datasets.

III. Process sequence to create input datasets needed to run CTSM

    1.) Create SCRIP grid files (if needed)

       a.) For standard resolutions these files will already be created. (done)

       b.) To create regular lat-lon regional/single-point grids run site_and_regional/mknoocnmap.pl

        This will create both SCRIP grid files and a mapping file that will
        be valid if the region includes NO ocean whatsoever (so you can skip step 2).
        You can also use this script to create SCRIP grid files for a region
        (or even a global grid) that DOES include ocean if you use step 2 to
        create mapping files for it (simply discard the non-ocean map created by
        this script).

        Example, for single-point over Boulder Colorado.

           cd site_and_regional
           ./mknoocnmap.pl -p 40,255 -n 1x1_boulderCO

       c.) General case

        You'll need to convert or create SCRIP grid files on your own (using scripts
        or other tools) for the general case where you have an unstructured grid, or 
        a grid that is not regular in latitude and longitude.

       example format
         ==================     
          netcdf fv1.9x2.5_090205 {                                
          dimensions:                                              
               grid_size = 13824 ;                                 
               grid_corners = 4 ;                                  
               grid_rank = 2 ;                                     
          variables:                                               
               double grid_center_lat(grid_size) ;                 
                       grid_center_lat:units = &quot;degrees&quot; ;         
               double grid_center_lon(grid_size) ;                 
                       grid_center_lon:units = &quot;degrees&quot; ;         
               double grid_corner_lat(grid_size, grid_corners) ;  
                       grid_corner_lat:units = &quot;degrees&quot; ;         
               double grid_corner_lon(grid_size, grid_corners) ;  
                       grid_corner_lon:units = &quot;degrees&quot; ;         
               int grid_dims(grid_rank) ;                          
               int grid_imask(grid_size) ;                         
                       grid_imask:units = &quot;unitless&quot; ;            

    2.) Create ocean to atmosphere mapping file (if needed)

        a.) Standard resolutions (done)

        If this is a standard resolution with a standard ocean resolution -- this
        step is already done, the files already exist.

        b.) Region without Ocean (done in step 1.b)

        IF YOU RAN mknoocnmap.pl FOR A REGION WITHOUT OCEAN THIS STEP IS ALREADY DONE.

        c.) New atmosphere or ocean resolution

        If the region DOES include ocean, use $CIMEROOT/tools/mapping/gen_domain_files/gen_maps.sh to create a 
        mapping file for it.

    Example:

    cd $CIMEROOT/tools/mapping/gen_domain_files
    ./gen_maps.sh -focn &lt;ocngrid&gt; -fatm &lt;atmgrid&gt; -nocn &lt;ocnname&gt; -natm &lt;atmname&gt;


    3.) Add SCRIP grid file(s) created in (1) into XML database in CTSM (optional)

        See the &quot;Adding New Resolutions or New Files to the build-namelist Database&quot; 
        Chapter in the CTSM User's Guide

  http://www.cesm.ucar.edu/models/cesm1.0/clm/models/lnd/clm/doc/UsersGuide/book1.html

         If you don't do this step, you'll need to specify the file to mksurfdata_esmf
         in step (3) using the &quot;-f&quot; option.

    4.) Convert map of ocean to atm for use by DATM and CTSM with gen_domain
        (See $CIMEROOT/tools/mapping/README for more help on doing this)

       - gen_domain uses the map from step (2) (or previously created CESM maps)

       Example:

        cd $CIMEROOT/tools/mapping/gen_domain_files/src
        gmake
        cd ..
        setenv CDATE       090206
        setenv OCNGRIDNAME gx1v6
        setenv ATMGRIDNAME fv1.9x2.5
        setenv MAPFILE $CSMDATA/cpl/cpl6/map_${OCNGRIDNAME}_to_${ATMGRIDNAME}_aave_da_${CDATE}.nc
        ./gen_domain -m $MAPFILE -o $OCNGRIDNAME -l $ATMGRIDNAME

        Normally for I compsets running CTSM only you will discard the ocean domain 
        file, and only use the atmosphere domain file for datm and as the fatmlndfrc 
        file for CTSM. Output domain files will be named according to the input OCN/LND
        gridnames.

    5.) Create surface datasets with mksurfdata_esmf on Derecho
        (See mksurfdata_esmf/README.md for more help on doing this)

       - gen_mksurfdata_build to build
       - gen_mksurfdata_namelist to build the namelist
       - gen_mksurfdata_jobscript_single to build a batch script to run on Derecho
       - Submit the batch script just created above

       - This step uses the results of step (3) entered into the XML database
         in step (4).
       - If datasets were NOT entered into the XML database, set the resolution
         by entering the mesh file using the options: --model-mesh --model-mesh-nx --model-mesh-ny

       Example: for 0.9x1.25 resolution fro 1850

       cd mksurfdata_esmf
       ./gen_mksurfdata_build
       ./gen_mksurfdata_namelist --res 0.9x1.25 --start-year 1850 --end-year 1850
       ./gen_mksurfdata_jobscript_single --number-of-nodes 24 --tasks-per-node 12 --namelist-file target.namelist
       qsub mksurfdata_jobscript_single.sh
   
       NOTE that surface dataset will be used by default for fatmgrid - and it will 
       contain the lat,lon,edges and area values for the atm grid - ASSUMING that 
       the atm and land grid are the same 

    6.) Add new files to XML data or using user_nl_clm (optional)

       See notes on doing this in step (3) above. 

IV.  Notes on which input datasets are needed for CTSM

       global or regional/single-point grids
         - need fsurdata and fatmlndfrc

      fsurdata ---- from mksurfdata_esmf in step (III.7)
      fatmlndfrc -- use the domain.lnd file from gen_domain in step (III.6)
</pre>
</div>
</div>


           </div>
           <div class="articleComments">
            
           </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="creating-domain-files.html" class="btn btn-neutral float-right" title="1.3.6. Creating CLM domain files" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="creating-input-for-surface-dataset-generation.html" class="btn btn-neutral" title="1.3.4. Creating input for surface dataset generation" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2020, UCAR.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
     
<script>var version_json_loc = "../../../../versions.json";</script>


</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="../../_static/language_data.js"></script>
        <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
        <script src="../../_static/pop_ver.js"></script>
    

  

  
  
    <script type="text/javascript" src="../../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>